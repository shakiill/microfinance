{% extends 'includes/main.html' %}
{% load static %}

{% block content %}

    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <!-- Main Application Details Card -->
                <div class="card card-custom gutter-b">
                    <div class="card-header">
                        <h3 class="card-title">Application #{{ object.id }}: {{ object.customer.name }}</h3>
                        <div class="card-toolbar">
                            <!-- Modal for Editing Application -->

                            <button type="button" class="btn btn-success loan-edit" data-toggle="modal"
                                    data-target="#editApplicationModal">edit application
                            </button>

                            <div class="modal fade" id="editApplicationModal" tabindex="-1" role="dialog"
                                 aria-labelledby="editApplicationModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="editApplicationModalLabel">Edit Application</h5>
                                            <button type="button" class="btn-close" data-dismiss="modal"
                                                    aria-label="Close">Cancel
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <form id="editApplicationForm">
                                                <div class="mb-3">
                                                    <label for="editAmount" class="form-label">Amount</label>
                                                    <input type="text" class="form-control" id="editAmount"
                                                           name="amount" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="editDuration" class="form-label">Duration
                                                        (Months)</label>
                                                    <input type="number" class="form-control" id="editDuration"
                                                           name="duration_months" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="editPurpose" class="form-label">Purpose</label>
                                                    <input type="text" class="form-control" id="editPurpose"
                                                           name="purpose">
                                                </div>

                                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <script>
                                // Function to open modal and fetch data
                                document.querySelector('.loan-edit').addEventListener('click', () => {
                                    fetch(`/api/v1/loan-applications/{{ object.id }}/`)
                                        .then(response => response.json())
                                        .then(data => {
                                            // Populate the form with the fetched data
                                            document.querySelector('#editAmount').value = data.amount;
                                            document.querySelector('#editDuration').value = data.duration_months;
                                            document.querySelector('#editPurpose').value = data.purpose;

                                            // Show the modal
                                            $('#editApplicationModal').modal('show');
                                        })
                                        .catch(error => console.error('Error fetching application data: ', error));
                                });

                                // Form submission to update application
                                document.querySelector('#editApplicationForm').addEventListener('submit', (event) => {
                                    event.preventDefault();

                                    // Form data gathering
                                    const formData = new FormData(event.target);
                                    const formObject = Object.fromEntries(formData.entries());

                                    fetch(`/api/v1/loan-applications/{{ object.id }}/`, {
                                        method: 'PATCH', // Use PATCH method to update the application',
                                        headers: {
                                            'Content-Type': 'application/json', // Set correct content type
                                            'X-CSRFToken': '{{ csrf_token }}', // Include CSRF token for Django
                                            'Accept': 'application/json'
                                        },
                                        body: JSON.stringify(formObject) // Send data as JSON
                                    })
                                        .then(response => {
                                            if (response.ok) {
                                                // Refresh the page to update the template upon success
                                                location.reload();
                                            } else {
                                                return response.json().then(data => {
                                                    console.error('Error updating application: ', data);
                                                });
                                            }
                                        })
                                        .catch(error => console.error('Error during update request: ', error));
                                });
                            </script>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3"><strong>Amount:</strong> {{ object.amount }}</div>
                            <div class="col-md-3"><strong>Duration:</strong> {{ object.duration_months }} months</div>
                            <div class="col-md-3"><strong>Status:</strong> {{ object.status }}</div>
                            <div class="col-md-3"><strong>Applied Date:</strong> {{ object.applied_date }}</div>
                        </div>
                    </div>
                </div>

                <!-- Tabs Navigation -->
                <ul class="nav nav-tabs" id="loanTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#products">Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#guarantors">Guarantors</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#assets">Assets</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#financials">Financial Records</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#checks">Check Info</a>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content mt-3">
                    <!-- Products Tab -->
                    <div class="tab-pane fade show active" id="products">
                        <div class="card card-custom">
                            <div class="card-header">
                                <h3 class="card-title">Products</h3>
                                <div class="card-toolbar">
                                    <button class="btn btn-success btn-sm product-add" data-toggle="modal"
                                            data-target="#createProductModal">
                                        Add Product
                                    </button>

                                    <div class="modal fade" id="createProductModal" tabindex="-1" role="dialog"
                                         aria-labelledby="createProductModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="createProductModalLabel">Add
                                                        Product</h5>
                                                    <button type="button" class="btn-close" data-dismiss="modal"
                                                            aria-label="Close">Cancel
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <form id="createProductForm">
                                                        <div style="display: none">
                                                            <input type="text" class="form-control" id="loanApplication"
                                                                   name="loan_application" value="{{ object.pk }}"
                                                                   required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="productName" class="form-label">Product
                                                                Name</label>
                                                            <input type="text" class="form-control" id="productName"
                                                                   name="product_name" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="unitType" class="form-label">Unit Type</label>
                                                            <input type="text" class="form-control" id="unitType"
                                                                   maxlength="10" name="unit_type" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="units" class="form-label">Units</label>
                                                            <input type="number" class="form-control" id="units"
                                                                   name="units" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="unitPrice" class="form-label">Unit Price</label>
                                                            <input type="number" step="0.01" class="form-control"
                                                                   id="unitPrice" name="unit_price" required>
                                                        </div>
                                                        <button type="submit" class="btn btn-primary">Save Product
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered datatable" id="productsTable">
                                    <thead>
                                    <tr>
                                        <th>Product Name</th>
                                        <th>Unit Type</th>
                                        <th>Units</th>
                                        <th>Unit Price</th>
                                        <th>Total Price</th>
                                        <th>Action</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for product in products %}
                                        <tr data-id="{{ product.id }}">
                                            <td>{{ product.product_name }}</td>
                                            <td>{{ product.unit_type }}</td>
                                            <td>{{ product.units }}</td>
                                            <td>{{ product.unit_price }}</td>
                                            <td>{{ product.total_price }}</td>
                                            <td>
                                                <button type="button" class="btn btn-secondary update-product"
                                                        data-id="{{ product.id }}">Edit
                                                </button>
                                                <button type="button" class="btn btn-danger delete-product"
                                                        data-id="{{ product.id }}">Delete
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <script>
                        let isEditing = false;
                        let currentProductId = null;

                        // Function to reset form
                        function resetForm() {
                            document.getElementById('createProductForm').reset();
                            isEditing = false;
                            currentProductId = null;
                            document.querySelector('#createProductModalLabel').textContent = 'Add Product';
                        }

                        // Function to convert FormData to JSON
                        function formDataToJson(formData) {
                            const object = {};
                            formData.forEach((value, key) => {
                                object[key] = value;
                            });
                            return object;
                        }

                        // Function to update table row
                        function updateTableRow(productId, data) {
                            const row = document.querySelector(`tr[data-id="${productId}"]`);
                            if (row) {
                                row.querySelector('td:nth-child(1)').textContent = data.product_name;
                                row.querySelector('td:nth-child(2)').textContent = data.unit_type;
                                row.querySelector('td:nth-child(3)').textContent = data.units;
                                row.querySelector('td:nth-child(4)').textContent = data.unit_price;
                                row.querySelector('td:nth-child(5)').textContent = (data.units * data.unit_price).toFixed(2);
                            }
                        }

                        // Function to add new row to table
                        function addTableRow(data) {
                            const tbody = document.querySelector('#productsTable tbody');
                            const newRow = document.createElement('tr');
                            newRow.setAttribute('data-id', data.id);
                            newRow.innerHTML = `
                                <td>${data.product_name}</td>
                                <td>${data.unit_type}</td>
                                <td>${data.units}</td>
                                <td>${data.unit_price}</td>
                                <td>${(data.units * data.unit_price).toFixed(2)}</td>
                                <td>
                                    <button type="button" class="btn btn-secondary update-product" data-id="${data.id}">Edit</button>
                                    <button type="button" class="btn btn-danger delete-product" data-id="${data.id}">Delete</button>
                                </td>
                            `;
                            tbody.appendChild(newRow);
                            attachEventListeners(newRow);
                        }

                        // Function to attach event listeners to row buttons
                        function attachEventListeners(row) {
                            row.querySelector('.update-product').addEventListener('click', handleEdit);
                            row.querySelector('.delete-product').addEventListener('click', handleDelete);
                        }

                        // Handle Add/Edit Product
                        document.querySelector('.product-add').addEventListener('click', () => {
                            resetForm();
                            $('#createProductModal').modal('show');
                        });

                        // Handle form submission
                        document.getElementById('createProductForm').addEventListener('submit', async function (event) {
                            event.preventDefault();

                            const formData = new FormData(this);
                            const jsonData = formDataToJson(formData);

                            const url = isEditing
                                ? `/api/v1/application-products/${currentProductId}/`
                                : '/api/v1/application-products/';

                            const method = isEditing ? 'PUT' : 'POST';

                            try {
                                const response = await fetch(url, {
                                    method: method,
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': '{{ csrf_token }}'
                                    },
                                    body: JSON.stringify(jsonData)
                                });

                                if (!response.ok) throw new Error('Request failed');

                                const data = await response.json();

                                if (isEditing) {
                                    updateTableRow(currentProductId, data);
                                } else {
                                    addTableRow(data);
                                }

                                $('#createProductModal').modal('hide');
                                resetForm();

                            } catch (error) {
                                console.error('Error:', error);
                                alert('An error occurred while saving the product.');
                            }
                        });

                        // Handle Edit
                        async function handleEdit() {
                            const productId = this.dataset.id;
                            currentProductId = productId;
                            isEditing = true;

                            try {
                                const response = await fetch(`/api/v1/application-products/${productId}/`);
                                if (!response.ok) throw new Error('Failed to fetch product details');

                                const data = await response.json();

                                document.querySelector('#createProductModalLabel').textContent = 'Edit Product';
                                document.querySelector('#productName').value = data.product_name;
                                document.querySelector('#unitType').value = data.unit_type;
                                document.querySelector('#units').value = data.units;
                                document.querySelector('#unitPrice').value = data.unit_price;

                                $('#createProductModal').modal('show');

                            } catch (error) {
                                console.error('Error:', error);
                                alert('An error occurred while fetching product details.');
                            }
                        }

                        // Handle Delete
                        async function handleDelete() {
                            const productId = this.dataset.id;
                            const row = this.closest('tr');

                            if (confirm('Are you sure you want to delete this product?')) {
                                try {
                                    const response = await fetch(`/api/v1/application-products/${productId}/`, {
                                        method: 'DELETE',
                                        headers: {
                                            'X-CSRFToken': '{{ csrf_token }}'
                                        }
                                    });

                                    if (!response.ok) throw new Error('Failed to delete product');

                                    row.remove();

                                } catch (error) {
                                    console.error('Error:', error);
                                    alert('An error occurred while deleting the product.');
                                }
                            }
                        }

                        // Modal close handler
                        $('#createProductModal').on('hidden.bs.modal', resetForm);

                        // Initial event listeners attachment
                        document.querySelectorAll('tr[data-id]').forEach(row => {
                            attachEventListeners(row);
                        });
                    </script>

                    <!-- Guarantors Tab -->
                    <div class="tab-pane fade" id="guarantors">
                        <div class="card card-custom">
                            <div class="card-header">
                                <h3 class="card-title">Guarantors</h3>
                                <div class="card-toolbar">
                                    <button class="btn btn-success btn-sm guarantor-add" data-toggle="modal"
                                            data-target="#createGuarantorModal">Add Guarantor
                                    </button>
                                </div>
                            </div>

                            <div class="card-body">
                                <table class="table table-bordered" id="guarantor-table">
                                    <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Relationship</th>
                                        <th>Mobile</th>
                                        <th>Address</th>
                                        <th>Deposit Amount</th>
                                        <th>Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for guarantor in guarantors %}
                                        <tr data-id="{{ guarantor.id }}">
                                            <td>{{ guarantor.name }}</td>
                                            <td>{{ guarantor.relationship }}</td>
                                            <td>{{ guarantor.mobile }}</td>
                                            <td>{{ guarantor.address }}</td>
                                            <td>{{ guarantor.deposit_amount }}</td>
                                            <td>
                                                <button type="button" class="btn btn-secondary update-guarantor"
                                                        data-id="{{ guarantor.id }}">Edit
                                                </button>
                                                <button type="button" class="btn btn-danger delete-guarantor"
                                                        data-id="{{ guarantor.id }}">Delete
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {#                                    modal start #}
                            <div class="modal fade" id="createGuarantorModal" tabindex="-1"
                                 role="dialog" aria-labelledby="createGuarantorModalLabel"
                                 aria-hidden="true">
                                <div class="modal-dialog modal-lg" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title"
                                                id="createGuarantorModalLabel">Add
                                                Guarantor</h5>
                                            <button type="button" class="btn-close" data-dismiss="modal"
                                                    aria-label="Close">Cancel
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <form id="createGuarantorForm">
                                                <div style="display: none">
                                                    <input type="text" class="form-control"
                                                           id="loanApplicationGuarantor"
                                                           name="loan_application"
                                                           value="{{ object.pk }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="guarantorName"
                                                           class="form-label">Name</label>
                                                    <input type="text" class="form-control"
                                                           id="guarantorName" name="name"
                                                           required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="fatherName"
                                                           class="form-label">Father's Name</label>
                                                    <input type="text" class="form-control"
                                                           id="fatherName" name="father"
                                                           required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="motherName"
                                                           class="form-label">Mother's Name</label>
                                                    <input type="text" class="form-control"
                                                           id="motherName" name="mother"
                                                           required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="relationship"
                                                           class="form-label">Relationship</label>
                                                    <input type="text" class="form-control"
                                                           id="relationship" name="relationship"
                                                           required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="mobile" class="form-label">Mobile</label>
                                                    <input type="text" class="form-control"
                                                           id="mobile" name="mobile" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="address" class="form-label">Address</label>
                                                    <input type="text" class="form-control"
                                                           id="address" name="address" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="depositAmount"
                                                           class="form-label">Deposit
                                                        Amount</label>
                                                    <input type="number" step="0.01"
                                                           class="form-control"
                                                           id="depositAmount"
                                                           name="deposit_amount" required>
                                                </div>
                                                <button type="submit" class="btn btn-primary">
                                                    Save Guarantor
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <script>
                                document.addEventListener("DOMContentLoaded", function () {
                                    let form = document.getElementById("createGuarantorForm");
                                    let modal = $("#createGuarantorModal");
                                    let submitButton = form.querySelector("button[type='submit']");

                                    // Hidden input field to track update mode
                                    let hiddenGuarantorId = document.createElement("input");
                                    hiddenGuarantorId.type = "hidden";
                                    hiddenGuarantorId.id = "guarantorId";
                                    hiddenGuarantorId.name = "guarantor_id";
                                    form.appendChild(hiddenGuarantorId);

                                    // Open "Create Guarantor" Modal (Reset Form)
                                    document.querySelector(".guarantor-add").addEventListener("click", () => {
                                        form.reset();  // Clear all fields
                                        hiddenGuarantorId.value = "";  // Clear edit ID
                                        submitButton.innerText = "Save Guarantor";  // Change button text
                                        modal.modal("show");
                                    });

                                    // Handle Form Submission
                                    form.addEventListener("submit", function (event) {
                                        event.preventDefault();

                                        let guarantorId = hiddenGuarantorId.value.trim();
                                        let formData = new FormData(this);
                                        let url = "/api/v1/guarantors/";
                                        let method = "POST";  // Default is create

                                        if (guarantorId) {
                                            url = `/api/v1/guarantors/${guarantorId}/`;
                                            method = "PUT";  // If ID exists, it's an update
                                        }

                                        fetch(url, {
                                            method: method,
                                            body: formData,
                                            headers: {
                                                "X-CSRFToken": "{{ csrf_token }}"
                                            }
                                        })
                                            .then(response => {
                                                if (response.ok) return response.json();
                                                throw new Error("Failed to save guarantor.");
                                            })
                                            .then(() => {
                                                alert(guarantorId ? "Guarantor updated successfully!" : "Guarantor created successfully!");
                                                modal.modal("hide");

                                                // Refresh with the correct tab
                                                const params = new URLSearchParams(window.location.search);
                                                params.set("tab", "guarantors");
                                                window.location.replace(window.location.pathname + "?" + params.toString());
                                            })
                                            .catch(error => {
                                                console.error("Error:", error);
                                                alert("An error occurred while saving the guarantor.");
                                            });
                                    });

                                    // Open "Edit Guarantor" Modal
                                    document.querySelectorAll(".update-guarantor").forEach(button => {
                                        button.addEventListener("click", function () {
                                            let guarantorId = this.dataset.id;

                                            fetch(`/api/v1/guarantors/${guarantorId}/`)
                                                .then(response => {
                                                    if (!response.ok) throw new Error("Failed to fetch guarantor details.");
                                                    return response.json();
                                                })
                                                .then(data => {
                                                    // Populate form fields with fetched data
                                                    document.getElementById("guarantorName").value = data.name;
                                                    document.getElementById("fatherName").value = data.father;
                                                    document.getElementById("motherName").value = data.mother;
                                                    document.getElementById("relationship").value = data.relationship;
                                                    document.getElementById("mobile").value = data.mobile;
                                                    document.getElementById("address").value = data.address;
                                                    document.getElementById("depositAmount").value = data.deposit_amount;

                                                    hiddenGuarantorId.value = guarantorId;  // Set ID for update
                                                    submitButton.innerText = "Update Guarantor";  // Change button text
                                                    modal.modal("show");
                                                })
                                                .catch(error => {
                                                    console.error("Error:", error);
                                                    alert("An error occurred while fetching guarantor details.");
                                                });
                                        });
                                    });


                                });

                                // Ensure delete functionality works even after updates
                                // AJAX handler for deleting a product
                                document.querySelectorAll('.delete-guarantor').forEach(button => {
                                    button.addEventListener('click', function () {
                                        const guarantorId = this.dataset.id;

                                        if (confirm('Are you sure you want to delete this guarantor?')) {
                                            // AJAX request to delete product
                                            fetch(`/api/v1/guarantors/${guarantorId}/`, {
                                                method: 'DELETE',
                                                headers: {
                                                    'X-CSRFToken': '{{ csrf_token }}'
                                                }
                                            })
                                                .then(response => {
                                                    if (response.ok) {
                                                        alert('Guarantor deleted successfully!');
                                                        const params = new URLSearchParams(window.location.search);
                                                        params.set("tab", "guarantors");  // Set or update the 'tab' parameter
                                                        window.location.replace(window.location.pathname + "?" + params.toString());
                                                    } else {
                                                        throw new Error('Failed to delete product.');
                                                    }
                                                })
                                                .catch(error => {
                                                    console.error('Error:', error);
                                                    alert('An error occurred while deleting the product.');
                                                });
                                        }
                                    });
                                });


                            </script>

                            {#                                    end modal#}
                        </div>
                    </div>

                    <!-- Assets Tab -->
                    <div class="tab-pane fade" id="assets">
                        <div class="card card-custom">
                            <div class="card-header">
                                <h3 class="card-title">Assets</h3>
                                <div class="card-toolbar">
                                    <button class="btn btn-success btn-sm asset-add" data-toggle="modal"
                                            data-target="#createAssetModal">Add Asset
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered datatable">
                                    <thead>
                                    <tr>
                                        <th>Land Type</th>
                                        <th>Owner</th>
                                        <th>Mouza No</th>
                                        <th>Dag No</th>
                                        <th>Khatian No</th>
                                        <th>Holding No</th>
                                        <th>Area</th>
                                        <th>Value</th>
                                        <th>Year of Mortgage</th>
                                        <th>Documents</th>
                                        <th>Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for asset in assets %}
                                        <tr data-id="{{ asset.id }}">
                                            <td>{{ asset.get_land_type_display }}</td>
                                            <td>{{ asset.owner_name }}</td>
                                            <td>{{ asset.mouza_no }}</td>
                                            <td>{{ asset.dag_no }}</td>
                                            <td>{{ asset.khatian_no }}</td>
                                            <td>{{ asset.holding_no }}</td>
                                            <td>{{ asset.land_area }}</td>
                                            <td>{{ asset.estimated_value }}</td>
                                            <td>{{ asset.year_of_mortgage|default_if_none:'' }}</td>
                                            <td>
                                                {% if asset.document %}
                                                    <a href="{{ asset.document.url }}" target="_blank">View</a>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-secondary update-asset"
                                                        data-id="{{ asset.id }}">Edit
                                                </button>
                                                <button type="button" class="btn btn-danger delete-asset"
                                                        data-id="{{ asset.id }}">Delete
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Asset Modal -->
                            <div class="modal fade" id="createAssetModal" tabindex="-1" role="dialog"
                                 aria-labelledby="createAssetModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="createAssetModalLabel">Add Asset</h5>
                                            <button type="button" class="btn-close" data-dismiss="modal"
                                                    aria-label="Close">Cancel
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <form id="createAssetForm">
                                                <input type="hidden" id="assetId" name="id" value="">
                                                <input type="hidden" value="{{ object.pk }}" id="loanApplicationId"
                                                       name="loan_application"
                                                       required>

                                                <div class="mb-3">
                                                    <label for="landType" class="form-label">Land Type</label>
                                                    <select class="form-control" id="landType" name="land_type"
                                                            required>
                                                        <option value="agricultural">Agricultural Land</option>
                                                        <option value="residential">Residential Land</option>
                                                        <option value="commercial">Commercial Land</option>
                                                        <option value="industrial">Industrial Land</option>
                                                    </select>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="ownerName" class="form-label">Owner Name</label>
                                                    <input type="text" class="form-control" id="ownerName"
                                                           name="owner_name" required maxlength="255">
                                                </div>

                                                <div class="mb-3">
                                                    <label for="mouzaNo" class="form-label">Mouza No</label>
                                                    <input type="text" class="form-control" id="mouzaNo"
                                                           name="mouza_no" maxlength="50">
                                                </div>

                                                <div class="mb-3">
                                                    <label for="dagNo" class="form-label">Dag No</label>
                                                    <input type="text" class="form-control" id="dagNo"
                                                           name="dag_no" maxlength="50">
                                                </div>

                                                <div class="mb-3">
                                                    <label for="khatianNo" class="form-label">Khatian No</label>
                                                    <input type="text" class="form-control" id="khatianNo"
                                                           name="khatian_no" maxlength="50">
                                                </div>

                                                <div class="mb-3">
                                                    <label for="holdingNo" class="form-label">Holding No</label>
                                                    <input type="text" class="form-control" id="holdingNo"
                                                           name="holding_no" maxlength="50">
                                                </div>

                                                <div class="mb-3">
                                                    <label for="landArea" class="form-label">Land Area (in
                                                        decimals)</label>
                                                    <input type="number" class="form-control" id="landArea"
                                                           name="land_area" step="0.01" required>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="estimatedValue" class="form-label">Estimated
                                                        Value</label>
                                                    <input type="number" class="form-control" id="estimatedValue"
                                                           name="estimated_value" step="0.01" required>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="description" class="form-label">Description</label>
                                                    <textarea class="form-control" id="description"
                                                              name="description"></textarea>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="yearOfMortgage" class="form-label">Year of
                                                        Mortgage</label>
                                                    <input type="number" class="form-control" id="yearOfMortgage"
                                                           name="year_of_mortgage" min="1900" max="2100">
                                                </div>

                                                <div class="mb-3">
                                                    <label for="document" class="form-label">Document</label>
                                                    <input type="file" class="form-control" id="document"
                                                           name="document">
                                                </div>

                                                <button type="submit" class="btn btn-primary">Save Asset</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <script>
                                document.addEventListener("DOMContentLoaded", function () {
                                    const form = document.getElementById("createAssetForm");
                                    const modal = $("#createAssetModal");
                                    const submitButton = form.querySelector("button[type='submit']");
                                    const hiddenAssetId = document.getElementById("assetId");
                                    const hiddenLoanApplicationId = document.getElementById("loanApplicationId");
                                    const documentInput = document.getElementById("document");

                                    // Open "Add Asset" Modal
                                    document.querySelector(".asset-add").addEventListener("click", () => {
                                        form.reset();
                                        hiddenAssetId.value = "";
                                        submitButton.innerText = "Save Asset";
                                        modal.modal("show");
                                    });

                                    // Remove any existing submit event listeners to prevent double submission
                                    const oldSubmitListener = form.onsubmit;
                                    form.onsubmit = null;

                                    // Handle Form Submission for Create/Update
                                    form.addEventListener("submit", function (event) {
                                        event.preventDefault();

                                        const assetId = hiddenAssetId.value.trim();
                                        const formData = new FormData(this);

                                        // If no new document is uploaded, and there was an existing document, don't send empty file input
                                        const existingDocument = documentInput.getAttribute('data-existing-document');
                                        if (!documentInput.files.length && existingDocument) {
                                            formData.delete('document');
                                        }

                                        let url = "/api/v1/assets/";
                                        let method = "POST";

                                        if (assetId) {
                                            url = `/api/v1/assets/${assetId}/`;
                                            method = "PUT";
                                        }

                                        fetch(url, {
                                            method: method,
                                            body: formData,
                                            headers: {
                                                "X-CSRFToken": "{{ csrf_token }}"
                                            }
                                        })
                                            .then(response => {
                                                if (response.ok) return response.json();
                                                throw new Error("Failed to save asset.");
                                            })
                                            .then(() => {
                                                alert(assetId ? "Asset updated successfully!" : "Asset created successfully!");
                                                modal.modal("hide");
                                                const params = new URLSearchParams(window.location.search);
                                                params.set("tab", "assets");  // Set or update the 'tab' parameter
                                                window.location.replace(window.location.pathname + "?" + params.toString());
                                            })
                                            .catch(error => {
                                                console.error("Error:", error);
                                                alert("An error occurred while saving the asset.");
                                            });
                                    });

                                    // Open "Edit Asset" Modal
                                    document.querySelectorAll(".update-asset").forEach(button => {
                                        button.addEventListener("click", function () {
                                            const assetId = this.dataset.id;

                                            fetch(`/api/v1/assets/${assetId}/`)
                                                .then(response => {
                                                    if (!response.ok) throw new Error("Failed to fetch asset details.");
                                                    return response.json();
                                                })
                                                .then(data => {
                                                    document.getElementById("landType").value = data.land_type;
                                                    document.getElementById("ownerName").value = data.owner_name;
                                                    document.getElementById("mouzaNo").value = data.mouza_no;
                                                    document.getElementById("dagNo").value = data.dag_no;
                                                    document.getElementById("khatianNo").value = data.khatian_no;
                                                    document.getElementById("holdingNo").value = data.holding_no;
                                                    document.getElementById("landArea").value = data.land_area;
                                                    document.getElementById("estimatedValue").value = data.estimated_value;
                                                    document.getElementById("description").value = data.description || '';
                                                    document.getElementById("yearOfMortgage").value = data.year_of_mortgage || '';

                                                    // Store the existing document URL to prevent clearing
                                                    documentInput.setAttribute('data-existing-document', data.document || '');

                                                    hiddenAssetId.value = assetId;
                                                    hiddenLoanApplicationId.value = data.loan_application;

                                                    submitButton.innerText = "Update Asset";
                                                    modal.modal("show");
                                                })
                                                .catch(error => {
                                                    console.error("Error:", error);
                                                    alert("An error occurred while fetching asset details.");
                                                });
                                        });
                                    });

                                    // Delete Asset
                                    document.querySelectorAll(".delete-asset").forEach(button => {
                                        button.addEventListener("click", function () {
                                            const assetId = this.dataset.id;

                                            if (confirm("Are you sure you want to delete this asset?")) {
                                                fetch(`/api/v1/assets/${assetId}/`, {
                                                    method: "DELETE",
                                                    headers: {
                                                        "X-CSRFToken": "{{ csrf_token }}"
                                                    }
                                                })
                                                    .then(response => {
                                                        if (!response.ok) throw new Error("Failed to delete asset.");
                                                        alert("Asset deleted successfully!");
                                                        const params = new URLSearchParams(window.location.search);
                                                        params.set("tab", "assets");  // Set or update the 'tab' parameter
                                                        window.location.replace(window.location.pathname + "?" + params.toString());
                                                    })
                                                    .catch(error => {
                                                        console.error("Error:", error);
                                                        alert("An error occurred while deleting the asset.");
                                                    });
                                            }
                                        });
                                    });
                                });
                            </script>
                        </div>
                    </div>

                    <!-- Financial Records Tab -->


                    <div class="tab-pane fade" id="financials">
                        <div class="card card-custom">
                            <div class="card-header">
                                <h3 class="card-title">Financial Records</h3>
                                <div class="card-toolbar">
                                    <button class="btn btn-success btn-sm add-financial" data-toggle="modal"
                                            data-target="#financialModal">
                                        Add Record
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered datatable">
                                    <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Institution</th>
                                        <th>Amount</th>
                                        <th>Interest Rate</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody id="financial-records-list">
                                    {% for record in financials %}
                                        <tr data-id="{{ record.id }}">
                                            <td>{{ record.get_record_type_display }}</td>
                                            <td>{{ record.institution_name }}</td>
                                            <td>{{ record.amount }}</td>
                                            <td>{{ record.interest_rate }}%</td>
                                            <td>{{ record.outstanding_amount }}</td>
                                            <td>
                                                <button class="btn btn-primary btn-sm edit-financial"
                                                        data-id="{{ record.id }}">
                                                    Edit
                                                </button>
                                                <button class="btn btn-danger btn-sm delete-financial"
                                                        data-id="{{ record.id }}">
                                                    Delete
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Financial Record Modal -->
                        <div class="modal fade" id="financialModal" tabindex="-1" aria-labelledby="financialModalLabel"
                             aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="financialModalLabel">Add Financial Record</h5>
                                        <button type="button" class="btn-close" data-dismiss="modal"
                                                aria-label="Close">Cancel
                                        </button>
                                    </div>
                                    <form id="financialForm">
                                        <div class="modal-body">
                                            <input type="hidden" id="financialId" name="id">

                                            <div class="mb-3">
                                                <label for="recordType" class="form-label">Record Type</label>
                                                <select class="form-control" id="recordType" name="record_type"
                                                        required>
                                                    <option value="">Select</option>
                                                    <option value="investment">Investment</option>
                                                    <option value="loan">Existing Loan</option>
                                                </select>
                                            </div>

                                            <!-- Common Fields -->
                                            <div class="mb-3">
                                                <label for="institutionName" class="form-label">Institution Name</label>
                                                <input type="text" class="form-control" id="institutionName"
                                                       name="institution_name" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="amount" class="form-label">Amount</label>
                                                <input type="number" class="form-control" id="amount" name="amount"
                                                       step="0.01" min="0" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="interestRate" class="form-label">Interest Rate (%)</label>
                                                <input type="number" class="form-control" id="interestRate"
                                                       name="interest_rate" step="0.01" min="0">
                                            </div>
                                            <div class="mb-3">
                                                <label for="description" class="form-label">Description</label>
                                                <input type="text" class="form-control" id="description"
                                                       name="description">
                                            </div>

                                            <!-- Investment-specific Fields -->
                                            <div id="investmentFields" class="dynamic-fields" style="display:none;">
                                                <div class="mb-3">
                                                    <label for="maturityDate" class="form-label">Maturity Date</label>
                                                    <input type="date" class="form-control" id="maturityDate"
                                                           name="maturity_date">
                                                </div>
                                            </div>

                                            <!-- Loan-specific Fields -->
                                            <div id="loanFields" class="dynamic-fields" style="display:none;">
                                                <div class="mb-3">
                                                    <label for="outstandingAmount" class="form-label">Outstanding
                                                        Amount</label>
                                                    <input type="number" class="form-control" id="outstandingAmount"
                                                           name="outstanding_amount" step="0.01" min="0">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="monthlyInstallment" class="form-label">Monthly
                                                        Installment</label>
                                                    <input type="number" class="form-control" id="monthlyInstallment"
                                                           name="monthly_installment" step="0.01" min="0">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="endDate" class="form-label">End Date</label>
                                                    <input type="date" class="form-control" id="endDate"
                                                           name="end_date">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="submit" class="btn btn-primary">Save</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <script>
                        document.addEventListener("DOMContentLoaded", () => {
                            const csrfToken = "{{ csrf_token }}";
                            const loanApplicationId = "{{ object.pk }}";

                            // Dynamic Field Management
                            const recordTypeSelect = document.getElementById('recordType');
                            const investmentFields = document.getElementById('investmentFields');
                            const loanFields = document.getElementById('loanFields');

                            // Record Type Change Handling
                            recordTypeSelect.addEventListener('change', function () {
                                // Hide all dynamic fields first
                                investmentFields.style.display = 'none';
                                loanFields.style.display = 'none';

                                // Reset all type-specific inputs
                                investmentFields.querySelectorAll('input').forEach(input => input.value = '');
                                loanFields.querySelectorAll('input').forEach(input => input.value = '');

                                // Show fields based on selected record type
                                if (this.value === 'investment') {
                                    investmentFields.style.display = 'block';
                                } else if (this.value === 'loan') {
                                    loanFields.style.display = 'block';
                                }
                            });

                            // Open Add Financial Modal
                            document.querySelector('.add-financial').addEventListener('click', () => {
                                const form = document.getElementById('financialForm');
                                form.reset();

                                // Reset modal state
                                document.getElementById('financialId').value = '';
                                document.getElementById('financialModalLabel').innerText = "Add Financial Record";
                                investmentFields.style.display = 'none';
                                loanFields.style.display = 'none';

                                // Show modal
                                const modal = document.getElementById('financialModal');
                                modal.modal('show');
                            });

                            // Edit Financial Record
                            document.querySelectorAll('.edit-financial').forEach(button => {
                                button.addEventListener('click', function () {
                                    const financialId = this.dataset.id;

                                    fetch(`/api/v1/financial-records/${financialId}/`)
                                        .then(response => {
                                            if (!response.ok) throw new Error("Failed to fetch financial record details.");
                                            return response.json();
                                        })
                                        .then(data => {
                                            // Reset dynamic fields
                                            investmentFields.style.display = 'none';
                                            loanFields.style.display = 'none';

                                            // Populate common fields
                                            document.getElementById('financialId').value = data.id;
                                            document.getElementById('recordType').value = data.record_type;
                                            document.getElementById('institutionName').value = data.institution_name;
                                            document.getElementById('amount').value = data.amount;
                                            document.getElementById('interestRate').value = data.interest_rate;
                                            document.getElementById('description').value = data.description || '';

                                            // Populate type-specific fields
                                            if (data.record_type === 'investment') {
                                                document.getElementById('maturityDate').value = data.maturity_date || '';
                                                investmentFields.style.display = 'block';
                                            } else if (data.record_type === 'loan') {
                                                document.getElementById('outstandingAmount').value = data.outstanding_amount || '';
                                                document.getElementById('monthlyInstallment').value = data.monthly_installment || '';
                                                document.getElementById('endDate').value = data.end_date || '';
                                                loanFields.style.display = 'block';
                                            }

                                            document.getElementById('financialModalLabel').innerText = "Edit Financial Record";
                                            $('#financialModal').modal('show');
                                            document.querySelector("#financialModal button[type='submit']").innerText = "Update Financial Record";

                                        })
                                        .catch(error => {
                                            console.error(error);
                                            alert("Error fetching financial record: " + error.message);
                                        });
                                });
                            });

                            // Delete Financial Record
                            document.querySelectorAll('.delete-financial').forEach(button => {
                                button.addEventListener('click', function () {
                                    const financialId = this.dataset.id;
                                    const parentRow = this.closest('tr');

                                    if (confirm("Are you sure you want to delete this record?")) {
                                        fetch(`/api/v1/financial-records/${financialId}/`, {
                                            method: "DELETE",
                                            headers: {
                                                "X-CSRFToken": csrfToken,
                                                "Content-Type": "application/json"
                                            }
                                        })
                                            .then(response => {
                                                if (!response.ok) {
                                                    throw new Error("Failed to delete financial record.");
                                                }
                                                // Remove row from table
                                                parentRow.remove();
                                                alert("Financial Record deleted successfully!");
                                            })
                                            .catch(error => {
                                                console.error(error);
                                                alert("Error deleting financial record: " + error.message);
                                            });
                                    }
                                });
                            });

                            // Save Financial Record
                            document.getElementById('financialForm').addEventListener('submit', function (event) {
                                event.preventDefault();

                                const formData = new FormData(this);
                                const financialId = formData.get('id');
                                const recordType = formData.get('record_type');

                                // Prepare data object with type-specific fields
                                const data = {
                                    loan_application: loanApplicationId,
                                    record_type: recordType,
                                    institution_name: formData.get('institution_name'),
                                    amount: formData.get('amount'),
                                    interest_rate: formData.get('interest_rate') || 0,
                                    description: formData.get('description') || null
                                };

                                // Add type-specific fields
                                if (recordType === 'investment') {
                                    data.maturity_date = formData.get('maturity_date') || null;
                                } else if (recordType === 'loan') {
                                    data.outstanding_amount = formData.get('outstanding_amount') || null;
                                    data.monthly_installment = formData.get('monthly_installment') || null;
                                    data.end_date = formData.get('end_date') || null;
                                }

                                const url = financialId ? `/api/v1/financial-records/${financialId}/` : `/api/v1/financial-records/`;
                                const method = financialId ? "PUT" : "POST";

                                fetch(url, {
                                    method: method,
                                    body: JSON.stringify(data),
                                    headers: {
                                        "X-CSRFToken": csrfToken,
                                        "Content-Type": "application/json"
                                    }
                                })
                                    .then(response => {
                                        if (!response.ok) throw new Error("Failed to save financial record.");
                                        return response.json();
                                    })
                                    .then(() => {
                                        alert("Financial Record " + (financialId ? "updated" : "added") + " successfully!");
                                        const params = new URLSearchParams(window.location.search);
                                        params.set("tab", "financials");  // Set or update the 'tab' parameter
                                        window.location.replace(window.location.pathname + "?" + params.toString());

                                    })
                                    .catch(error => {
                                        console.error(error);
                                        alert("Error saving financial record: " + error.message);
                                    });
                            });
                        });
                    </script>


                    <!-- Check Info Tab -->
                    <div class="tab-pane fade" id="checks">
                        <div class="card card-custom">
                            <div class="card-header">
                                <h3 class="card-title">Check Information</h3>
                                <div class="card-toolbar">
                                    <button class="btn btn-success btn-sm add-check" data-toggle="modal"
                                            data-target="#checkModal">Add Check
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered datatable">
                                    <thead>
                                    <tr>
                                        <th>Account Name</th>
                                        <th>Account No</th>
                                        <th>Check No</th>
                                        <th>Bank</th>
                                        <th>Branch</th>
                                        <th>Remarks</th>
                                        <th>Image</th>
                                        <th>Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody id="check-records-list">
                                    {% for check in checks %}
                                        <tr data-id="{{ check.id }}">
                                            <td>{{ check.account_name }}</td>
                                            <td>{{ check.account_no }}</td>
                                            <td>{{ check.check_no }}</td>
                                            <td>{{ check.bank_name }}</td>
                                            <td>{{ check.branch_name }}</td>
                                            <td>{{ check.remarks }}</td>
                                            <td>
                                                {% if check.image %}
                                                    <img src="{{ check.image.url }}" alt="Check Image" width="50"/>
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button class="btn btn-primary btn-sm edit-check"
                                                        data-id="{{ check.id }}">Edit
                                                </button>
                                                <button class="btn btn-danger btn-sm delete-check"
                                                        data-id="{{ check.id }}">Delete
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Check Record Modal -->
                        <div class="modal fade" id="checkModal" tabindex="-1" aria-labelledby="checkModalLabel"
                             aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form id="checkForm" enctype="multipart/form-data">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="checkModalLabel">Add Check</h5>
                                            <button type="button" class="btn-close" data-dismiss="modal"
                                                    aria-label="Close">Cancel
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <input type="hidden" id="checkId" name="id">
                                            <input type="hidden" value="{{ object.pk }}" id="loanApplicationId"
                                                   name="loan_application"
                                                   required>
                                            <div class="mb-3">
                                                <label for="accountName" class="form-label">Account Name</label>
                                                <input type="text" class="form-control" id="accountName"
                                                       name="account_name" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="accountNo" class="form-label">Account No</label>
                                                <input type="text" class="form-control" id="accountNo" name="account_no"
                                                       required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="checkNo" class="form-label">Check No</label>
                                                <input type="text" class="form-control" id="checkNo" name="check_no"
                                                       required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="bankName" class="form-label">Bank Name</label>
                                                <input type="text" class="form-control" id="bankName" name="bank_name"
                                                       required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="branchName" class="form-label">Branch Name</label>
                                                <input type="text" class="form-control" id="branchName"
                                                       name="branch_name" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="remarks" class="form-label">Remarks</label>
                                                <textarea class="form-control" id="remarks" name="remarks"></textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label for="image" class="form-label">Check Image</label>
                                                <input type="file" class="form-control" id="image" name="image"
                                                       accept="image/*">
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="submit" class="btn btn-primary">Save</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                        document.addEventListener("DOMContentLoaded", () => {
                            const csrfToken = "{{ csrf_token }}";

                            // Open Add Check Modal
                            document.querySelector('.add-check').addEventListener('click', () => {
                                const form = document.getElementById('checkForm');
                                form.reset();

                                // Reset modal state
                                document.getElementById('checkId').value = '';
                                document.getElementById('checkModalLabel').innerText = "Add Check";

                                // Show modal
                                const modal = document.getElementById('checkModal');
                                modal.modal('show');
                            });

                            // Edit Check Record
                            document.querySelectorAll('.edit-check').forEach(button => {
                                button.addEventListener('click', function () {
                                    const checkId = this.dataset.id;

                                    fetch(`/api/v1/check-info/${checkId}/`)
                                        .then(response => {
                                            if (!response.ok) throw new Error("Failed to fetch check details.");
                                            return response.json();
                                        })
                                        .then(data => {
                                            document.getElementById('checkId').value = data.id;
                                            document.getElementById('accountName').value = data.account_name;
                                            document.getElementById('accountNo').value = data.account_no;
                                            document.getElementById('checkNo').value = data.check_no;
                                            document.getElementById('bankName').value = data.bank_name;
                                            document.getElementById('branchName').value = data.branch_name;
                                            document.getElementById('remarks').value = data.remarks;

                                            document.getElementById('checkModalLabel').innerText = "Edit Check";

                                            // Show modal
                                            document.getElementById('checkModalLabel').innerText = "Edit Check";
                                            document.querySelector("#checkModal button[type='submit']").innerText = "Update Check";

                                            // Use Bootstrap's built-in modal method
                                            $('#checkModal').modal('show');


                                        })
                                        .catch(error => {
                                            console.error(error);
                                            alert("Error fetching check details: " + error.message);
                                        });
                                });
                            });

                            // Delete Check Record
                            document.querySelectorAll('.delete-check').forEach(button => {
                                button.addEventListener('click', function () {
                                    const checkId = this.dataset.id;
                                    const parentRow = this.closest('tr');

                                    if (confirm("Are you sure you want to delete this check?")) {
                                        fetch(`/api/v1/check-info/${checkId}/`, {
                                            method: "DELETE",
                                            headers: {
                                                "X-CSRFToken": csrfToken,
                                                "Content-Type": "application/json"
                                            }
                                        })
                                            .then(response => {
                                                if (!response.ok) {
                                                    throw new Error("Failed to delete check.");
                                                }
                                                // Remove row from table
                                                parentRow.remove();
                                                alert("Check deleted successfully!");

                                            })
                                            .catch(error => {
                                                console.error(error);
                                                alert("Error deleting check: " + error.message);
                                            });
                                    }
                                });
                            });

                            // Save Check Record
                            document.getElementById('checkForm').addEventListener('submit', function (event) {
                                event.preventDefault();

                                const formData = new FormData(this);
                                const checkId = formData.get('id');

                                const url = checkId ? `/api/v1/check-info/${checkId}/` : `/api/v1/check-info/`;
                                const method = checkId ? "PUT" : "POST";

                                fetch(url, {
                                    method: method,
                                    body: formData,
                                    headers: {
                                        "X-CSRFToken": csrfToken
                                    }
                                })
                                    .then(response => {
                                        if (!response.ok) throw new Error("Failed to save check.");
                                        return response.json();
                                    })
                                    .then(() => {
                                        alert("Check " + (checkId ? "updated" : "added") + " successfully!");
                                        const params = new URLSearchParams(window.location.search);
                                        params.set("tab", "checks");  // Set or update the 'tab' parameter
                                        window.location.replace(window.location.pathname + "?" + params.toString());
                                    })
                                    .catch(error => {
                                        console.error(error);
                                        alert("Error saving check: " + error.message);
                                    });
                            });
                        });
                    </script>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block js %}

    <script>
        document.addEventListener('DOMContentLoaded', function () {


            // Get the current URL
            const urlParams = new URLSearchParams(window.location.search);
            // Check if 'tab' parameter exists in the URL
            const activeTab = urlParams.get('tab');

            if (activeTab) {
                // Find the tab link and content to activate using the URL parameter
                const tabLink = document.querySelector(`[href="#${activeTab}"]`);
                const tabPane = document.querySelector(`#${activeTab}`);

                if (tabLink && tabPane) {
                    // Deactivate currently active tab
                    document.querySelector('.nav-link.active')?.classList.remove('active');
                    document.querySelector('.tab-pane.show.active')?.classList.remove('show', 'active');

                    // Activate the tab based on the URL parameter
                    tabLink.classList.add('active');
                    tabPane.classList.add('show', 'active');
                }
            }

        });


    </script>
{% endblock %}