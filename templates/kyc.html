{% extends 'includes/main.html' %}
{% load static %}

{% block content %}

    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <!-- Main Application Details Card -->
                <div class="card card-custom gutter-b">
                    <div class="card-header">
                        <h3 class="card-title">Application #{{ object.id }}: {{ object.customer.name }}</h3>
                        <div class="card-toolbar">
                            <!-- Modal for Editing Application -->

                            <button type="button" class="btn btn-success loan-edit" data-toggle="modal"
                                    data-target="#editApplicationModal">edit application
                            </button>

                            <div class="modal fade" id="editApplicationModal" tabindex="-1" role="dialog"
                                 aria-labelledby="editApplicationModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="editApplicationModalLabel">Edit Application</h5>
                                            <button type="button" class="btn-close" data-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form id="editApplicationForm">
                                                <div class="mb-3">
                                                    <label for="editAmount" class="form-label">Amount</label>
                                                    <input type="text" class="form-control" id="editAmount"
                                                           name="amount" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="editDuration" class="form-label">Duration
                                                        (Months)</label>
                                                    <input type="number" class="form-control" id="editDuration"
                                                           name="duration_months" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="editPurpose" class="form-label">Purpose</label>
                                                    <input type="text" class="form-control" id="editPurpose"
                                                           name="purpose">
                                                </div>

                                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <script>
                                // Function to open modal and fetch data
                                document.querySelector('.loan-edit').addEventListener('click', () => {
                                    fetch(`/api/v1/loan-applications/{{ object.id }}/`)
                                        .then(response => response.json())
                                        .then(data => {
                                            // Populate the form with the fetched data
                                            document.querySelector('#editAmount').value = data.amount;
                                            document.querySelector('#editDuration').value = data.duration_months;
                                            document.querySelector('#editPurpose').value = data.purpose;

                                            // Show the modal
                                            $('#editApplicationModal').modal('show');
                                        })
                                        .catch(error => console.error('Error fetching application data: ', error));
                                });

                                // Form submission to update application
                                document.querySelector('#editApplicationForm').addEventListener('submit', (event) => {
                                    event.preventDefault();

                                    // Form data gathering
                                    const formData = new FormData(event.target);
                                    const formObject = Object.fromEntries(formData.entries());

                                    fetch(`/api/v1/loan-applications/{{ object.id }}/`, {
                                        method: 'PATCH', // Use PATCH method to update the application',
                                        headers: {
                                            'Content-Type': 'application/json', // Set correct content type
                                            'X-CSRFToken': '{{ csrf_token }}', // Include CSRF token for Django
                                            'Accept': 'application/json'
                                        },
                                        body: JSON.stringify(formObject) // Send data as JSON
                                    })
                                        .then(response => {
                                            if (response.ok) {
                                                // Refresh the page to update the template upon success
                                                location.reload();
                                            } else {
                                                return response.json().then(data => {
                                                    console.error('Error updating application: ', data);
                                                });
                                            }
                                        })
                                        .catch(error => console.error('Error during update request: ', error));
                                });
                            </script>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3"><strong>Amount:</strong> {{ object.amount }}</div>
                            <div class="col-md-3"><strong>Duration:</strong> {{ object.duration_months }} months</div>
                            <div class="col-md-3"><strong>Status:</strong> {{ object.status }}</div>
                            <div class="col-md-3"><strong>Applied Date:</strong> {{ object.applied_date }}</div>
                        </div>
                    </div>
                </div>

                <!-- Tabs Navigation -->
                <ul class="nav nav-tabs" id="loanTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#products">Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#guarantors">Guarantors</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#assets">Assets</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#financials">Financial Records</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#checks">Check Info</a>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content mt-3">
                    <!-- Products Tab -->
                    <div class="tab-pane fade show active" id="products">
                        <div class="card card-custom">
                            <div class="card-header">
                                <h3 class="card-title">Products</h3>
                                <div class="card-toolbar">
                                    <button class="btn btn-success btn-sm product-add" data-toggle="modal"
                                            data-target="#createProductModal">Add Product
                                    </button>

                                    <div class="modal fade" id="createProductModal" tabindex="-1" role="dialog"
                                         aria-labelledby="createProductModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="createProductModalLabel">Add
                                                        Product</h5>
                                                    <button type="button" class="btn-close" data-dismiss="modal"
                                                            aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <form id="createProductForm">
                                                        <div style="display: none">
                                                            <input type="text" class="form-control" id="loanApplication"
                                                                   name="loan_application" value="{{ object.pk }}" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="productName" class="form-label">Product
                                                                Name</label>
                                                            <input type="text" class="form-control" id="productName"
                                                                   name="product_name" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="unitType" class="form-label">Unit Type</label>
                                                            <input type="text" class="form-control" id="unitType"
                                                                   name="unit_type" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="units" class="form-label">Units</label>
                                                            <input type="number" class="form-control" id="units"
                                                                   name="units" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="unitPrice" class="form-label">Unit Price</label>
                                                            <input type="number" step="0.01" class="form-control"
                                                                   id="unitPrice" name="unit_price" required>
                                                        </div>
                                                        <button type="submit" class="btn btn-primary">Save Product
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <script>
                                        // Function to open modal and fetch data
                                        document.querySelector('.product-add').addEventListener('click', () => {
                                            $('#createProductModal').modal('show');
                                        });
                                        // AJAX form submission for creating a product
                                        document.getElementById('createProductForm').addEventListener('submit',
                                            function (event) {
                                                event.preventDefault(); // Prevent default form submission

                                                // Collect form data
                                                const formData = new FormData(this);

                                                // Send AJAX request
                                                fetch('/api/v1/application-products/', { // Replace with your endpoint for product creation
                                                    method: 'POST',
                                                    body: formData,
                                                    headers: {
                                                        'X-CSRFToken': '{{ csrf_token }}' // Ensure CSRF token is included
                                                    }
                                                })
                                                    .then(response => {
                                                        if (response.ok) {
                                                            return response.json();
                                                        } else {
                                                            throw new Error('Failed to create product.');
                                                        }
                                                    })
                                                    .then(data => {
                                                        // Handle success
                                                        alert('Product created successfully!');
                                                        $('#createProductModal').modal('hide');
                                                        location.reload(); // Optionally reload the page to update the table
                                                    })
                                                    .catch(error => {
                                                        // Handle error
                                                        console.error('Error:', error);
                                                        alert('An error occurred while creating the product.');
                                                    });
                                            });
                                    </script>

                                </div>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered datatable">
                                    <thead>
                                    <tr>
                                        <th>Product Name</th>
                                        <th>Unit Type</th>
                                        <th>Units</th>
                                        <th>Unit Price</th>
                                        <th>Total Price</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for product in products %}
                                        <tr data-id="{{ product.id }}">
                                            <td>{{ product.product_name }}</td>
                                            <td>{{ product.unit_type }}</td>
                                            <td>{{ product.unit }}</td>
                                            <td>{{ product.unit_price }}</td>
                                            <td>{{ product.total_price }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Guarantors Tab -->
                    <div class="tab-pane fade" id="guarantors">
                        <div class="card card-custom">
                            <div class="card-header">
                                <h3 class="card-title">Guarantors</h3>
                                <div class="card-toolbar">
                                    <button class="btn btn-success btn-sm">Add Guarantor
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered datatable">
                                    <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Relationship</th>
                                        <th>Mobile</th>
                                        <th>Address</th>
                                        <th>Deposit Amount</th>
                                        <th>Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for guarantor in guarantors %}
                                        <tr data-id="{{ guarantor.id }}">
                                            <td>{{ guarantor.name }}</td>
                                            <td>{{ guarantor.relationship }}</td>
                                            <td>{{ guarantor.mobile }}</td>
                                            <td>{{ guarantor.address }}</td>
                                            <td>{{ guarantor.deposit_amount }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Assets Tab -->
                    <div class="tab-pane fade" id="assets">
                        <div class="card card-custom">
                            <div class="card-header">
                                <h3 class="card-title">Assets</h3>
                                <div class="card-toolbar">
                                    <button class="btn btn-success btn-sm">Add Asset</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered datatable">
                                    <thead>
                                    <tr>
                                        <th>Land Type</th>
                                        <th>Owner</th>
                                        <th>Area</th>
                                        <th>Value</th>
                                        <th>Documents</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for asset in assets %}
                                        <tr data-id="{{ asset.id }}">
                                            <td>{{ asset.get_land_type_display }}</td>
                                            <td>{{ asset.owner_name }}</td>
                                            <td>{{ asset.land_area }}</td>
                                            <td>{{ asset.estimated_value }}</td>
                                            <td>
                                                {% if asset.document %}
                                                    <a href="{{ asset.document.url }}" target="_blank">View</a>
                                                {% endif %}
                                            </td>

                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Records Tab -->
                    <div class="tab-pane fade" id="financials">
                        <div class="card card-custom">
                            <div class="card-header">
                                <h3 class="card-title">Financial Records</h3>
                                <div class="card-toolbar">
                                    <button class="btn btn-success btn-sm">Add Record
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered datatable">
                                    <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Institution</th>
                                        <th>Amount</th>
                                        <th>Interest Rate</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for record in financials %}
                                        <tr data-id="{{ record.id }}">
                                            <td>{{ record.get_record_type_display }}</td>
                                            <td>{{ record.institution_name }}</td>
                                            <td>{{ record.amount }}</td>
                                            <td>{{ record.interest_rate }}%</td>
                                            <td>{{ record.status }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Check Info Tab -->
                    <div class="tab-pane fade" id="checks">
                        <div class="card card-custom">
                            <div class="card-header">
                                <h3 class="card-title">Check Information</h3>
                                <div class="card-toolbar">
                                    <button class="btn btn-success btn-sm">Add Check</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered datatable">
                                    <thead>
                                    <tr>
                                        <th>Account Name</th>
                                        <th>Account No</th>
                                        <th>Check No</th>
                                        <th>Bank</th>
                                        <th>Branch</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for check in checks %}
                                        <tr data-id="{{ check.id }}">
                                            <td>{{ check.account_name }}</td>
                                            <td>{{ check.account_no }}</td>
                                            <td>{{ check.check_no }}</td>
                                            <td>{{ check.bank_name }}</td>
                                            <td>{{ check.branch_name }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block js %}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Get the current URL
            const urlParams = new URLSearchParams(window.location.search);
            // Check if 'tab' parameter exists in the URL
            const activeTab = urlParams.get('tab');

            if (activeTab) {
                // Find the tab link and content to activate using the URL parameter
                const tabLink = document.querySelector(`[href="#${activeTab}"]`);
                const tabPane = document.querySelector(`#${activeTab}`);

                if (tabLink && tabPane) {
                    // Deactivate currently active tab
                    document.querySelector('.nav-link.active')?.classList.remove('active');
                    document.querySelector('.tab-pane.show.active')?.classList.remove('show', 'active');

                    // Activate the tab based on the URL parameter
                    tabLink.classList.add('active');
                    tabPane.classList.add('show', 'active');
                }
            }
        });
    </script>
{% endblock %}